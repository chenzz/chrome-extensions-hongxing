(function(){var r,e;r=["underscore","debug","angular","core/services/timeUtils","core/services/domainUtils","background/module","background/services/userDomains"],e=function(r,e,n){var u,tabsTracker;return u=e("tabsTracker"),tabsTracker=function($rootScope,$timeout,timeUtils,domainUtils,userDomains){var e,o,i,s,a,c,d,l,f,m,b,h,v,T,p,I;return o=1e4,e={id:null,url:"",domains:{},requestTimers:{}},T={},p=r.throttle(function(){return setTimeout(function(){return $rootScope.$apply()})},300),s=function(){return $rootScope.currentTabId=-1,$rootScope.currentTab={},$rootScope.blockedDomains=[],chrome.webRequest.onBeforeRequest.addListener(a,{urls:["<all_urls>"]}),chrome.webRequest.onErrorOccurred.addListener(l,{urls:["<all_urls>"]}),chrome.webRequest.onCompleted.addListener(d,{urls:["<all_urls>"]}),chrome.tabs.onRemoved.addListener(m),chrome.tabs.onActivated.addListener(f),chrome.windows.onFocusChanged.addListener(b),chrome.tabs.query({active:!0,currentWindow:!0},function(r){return 0!==(r||[]).length?($rootScope.currentTabId=r[0].id,p()):void 0}),$rootScope.$watch("currentTabId",function(r){var e;return e=i(r),$rootScope.currentTab=e}),$rootScope.$watch("currentTab.domains",c,!0)},i=function(r){var u;if(!(0>r))return u=T[r],u||(u=n.copy(e),u.id=r,setTimeout(function(){return u.url?void 0:chrome.tabs.get(r,function(r){return r&&(u.url=r.url),p()})}),T[r]=u),u},I=function(r,e,n,o){var s,a,c,d;return s=i(r),(a=s.requestTimers[e])?(clearTimeout(a),delete s.requestTimers[e],null==(c=s.domains)[n]&&(c[n]={}),null==(d=s.domains[n])[o]&&(d[o]=0),s.domains[n][o]+=1,u("[%s] %s %s",o,n,JSON.stringify(s.domains[n])),s):void 0},h=function(r){return v(r),delete T[r]},v=function(r){var e,n,u,o;if(e=i(r)){u=e.requestTimers;for(o in u)n=u[o],clearTimeout(n);return e.domains={}}},a=function(r){var e,n,u;if(!(r.tabId<0||"other"===r.type)&&"https://www.googleapis.com/rpc"!==r.url)return e=domainUtils.parseUri(r.url).host,"main_frame"===r.type?(v(r.tabId),u=i(r.tabId),u.url=r.url):u=i(r.tabId),n=setTimeout(function(){return I(r.tabId,r.requestId,e,"timeout"),p()},o),u.requestTimers[r.requestId]=n,p()},l=function(r){var e,n,u;if(!(r.tabId<0||"other"===r.type))return e=domainUtils.parseUri(r.url).host,n="blocked",("net::ERR_BLOCKED_BY_CLIENT"===(u=r.error)||"net::ERR_ABORTED"===u)&&(n="ok"),I(r.tabId,r.requestId,e,n),p()},d=function(r){var e,n;if(!(r.tabId<0||"other"===r.type))return e=domainUtils.parseUri(r.url).host,n="ok",403===r.status&&(n="blocked"),I(r.tabId,r.requestId,e,n),p()},m=function(r){return h(r),p()},f=function(r){var e;return e=i(r.tabId),$rootScope.currentTab=e,p()},b=function(r){return chrome.tabs.query({active:!0,windowId:r,currentWindow:!0},function(){return function(r){var e;if(r&&0!==r.length)return e=i(r[0].id),$rootScope.currentTab=e,p()}}(this))},c=function(r){var e,n,u,o,i,s,a,c,d,l,f,m;n={};for(e in r)c=r[e],i=c.ok||0,u=(c.timeout||0)+(c.blocked||0),a=i>u?"ok":"error",l=domainUtils.topDomain(e),null==n[l]&&(n[l]={}),n[l][e]=a;s=[];for(l in n){d=n[l],u=0,i=0,o=[];for(e in d)a=d[e],"error"===a?(u+=1,o.push(e)):i+=1;if(!userDomains.match(l))if(0===i)s.push(l);else if(u>=i)s.push(l);else if(u>=2)s.push(l);else for(f=0,m=o.length;m>f;f++)e=o[f],userDomains.match(e)||s.push(e)}return $rootScope.blockedDomains=s},s(),window.tabsMap=T,this},n.module("background").service("tabsTracker",tabsTracker)},define(r,e)}).call(this);